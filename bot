import yfinance as yf
import pandas as pd
import ta
import schedule
import time
import os
import logging
from dotenv import load_dotenv

# ØªØ­Ù…ÙŠÙ„ Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ù…Ù† Ù…Ù„Ù .env
load_dotenv()

# Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
logging.basicConfig(filename='bot.log',
                    level=logging.INFO,
                    format='%(asctime)s - %(message)s')

# Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ (Ù…Ø¹Ø·Ù‘ÙÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
email = os.getenv("TRADING_EMAIL")
app_password = os.getenv("TRADING_APP_PASSWORD")

def send_signal_email(symbol, signal, confirmation, support, resistance, recommended_price):
    """ØªØ¹Ø·ÙŠÙ„ Ù…Ø¤Ù‚Øª Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„"""
    pass

def save_signal(symbol, signal, confirmation, support, resistance, recommended_price):
    df = pd.DataFrame([{
        'Time': pd.Timestamp.now(),
        'Symbol': symbol,
        'Signal': signal,
        'Confirmation': confirmation,
        'Support': support,
        'Resistance': resistance,
        'Recommended Price': recommended_price
    }])
    df.to_csv("signals_log.csv",
              mode='a',
              header=not os.path.exists("signals_log.csv"),
              index=False)

def get_support_resistance(data, window=20):
    recent = data[-window:]
    return recent['Low'].min(), recent['High'].max()

def analyze_price_action(data):
    last = data['Close'].iloc[-1]
    support, resistance = get_support_resistance(data)
    support = float(support)
    resistance = float(resistance)

    signal, confirmation = None, ""
    recommended_price = None

    if last < support * 0.995:
        signal, confirmation = "ÙƒØ³Ø± Ø¯Ø¹Ù…", "Ø¥ØºÙ„Ø§Ù‚ ØªØ­Øª Ø§Ù„Ø¯Ø¹Ù…"
        recommended_price = support * 0.99
    elif last > resistance * 1.005:
        signal, confirmation = "ÙƒØ³Ø± Ù…Ù‚Ø§ÙˆÙ…Ø©", "Ø¥ØºÙ„Ø§Ù‚ ÙÙˆÙ‚ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©"
        recommended_price = resistance * 1.01
    elif abs(last - support) / support < 0.005:
        signal, confirmation = "Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ø¯Ø¹Ù…", "Ø´Ù…Ø¹Ø© Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ©"
        recommended_price = support
    elif abs(last - resistance) / resistance < 0.005:
        signal, confirmation = "Ø§Ø±ØªØ¯Ø§Ø¯ Ù…Ù† Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©", "Ø´Ù…Ø¹Ø© Ø§Ù†Ø¹ÙƒØ§Ø³ÙŠØ©"
        recommended_price = resistance

    return signal, confirmation, support, resistance, recommended_price

def analyze_symbol(symbol):
    try:
        data = yf.download(
            symbol,
            interval="1h",
            period="7d",
            progress=False,
            auto_adjust=True
        ).dropna()

        close_series = data['Close']
        # ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† close_series Ù‡Ùˆ Series (1D)
        if isinstance(close_series, pd.DataFrame):
            close_series = close_series.squeeze()

        # Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„ÙÙ†ÙŠØ©
        data['RSI']     = ta.momentum.RSIIndicator(close_series).rsi()
        data['EMA_7']   = ta.trend.EMAIndicator(close_series, 7).ema_indicator()
        data['EMA_50']  = ta.trend.EMAIndicator(close_series, 50).ema_indicator()
        data['EMA_100'] = ta.trend.EMAIndicator(close_series, 100).ema_indicator()
        data['EMA_200'] = ta.trend.EMAIndicator(close_series, 200).ema_indicator()
        data['SMA_50']  = ta.trend.SMAIndicator(close_series, 50).sma_indicator()

        last_rsi = data['RSI'].iloc[-1]
        last_close = close_series.iloc[-1]

        # ØªØ¬Ø§Ù‡Ù„ Ø¥Ø°Ø§ RSI Ø¨ÙŠÙ† 30 Ùˆ 70 (Ù…Ø­Ø§ÙŠØ¯)
        if 30 < last_rsi < 70:
            logging.info(f"{symbol}: RSI Ù…Ø­Ø§ÙŠØ¯ ({last_rsi:.2f}) â€“ ØªØ¬Ø§Ù‡ÙÙ„.")
            return

        signal, conf, sup, res, rec_price = analyze_price_action(data)
        if signal:
            save_signal(symbol, signal, conf, sup, res, rec_price)
            # send_signal_email(symbol, signal, conf, sup, res, rec_price)  # ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø­Ø§Ù„ÙŠØ§Ù‹
            log_msg = (
                f"{symbol}: Ø¥Ø´Ø§Ø±Ø© â†’ {signal} âœ…\n"
                f"Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø­Ø§Ù„ÙŠ: {last_close:.4f}\n"
                f"Ø§Ù„Ø¯Ø¹Ù…: {sup:.4f}ØŒ Ø§Ù„Ù…Ù‚Ø§ÙˆÙ…Ø©: {res:.4f}\n"
                f"Ø§Ù„Ø´Ø±Ø­: {conf}\n"
                f"Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…ÙˆØµÙ‰ Ø¨Ù‡: {rec_price:.4f}\n"
                f"Ù…Ø¤Ø´Ø±Ø§Øª:\n"
                f"RSI: {last_rsi:.2f}\n"
                f"EMA 7: {data['EMA_7'].iloc[-1]:.4f}\n"
                f"EMA 50: {data['EMA_50'].iloc[-1]:.4f}\n"
                f"EMA 100: {data['EMA_100'].iloc[-1]:.4f}\n"
                f"EMA 200: {data['EMA_200'].iloc[-1]:.4f}\n"
                f"SMA 50: {data['SMA_50'].iloc[-1]:.4f}"
            )
            logging.info(log_msg)
            print(log_msg)
        else:
            logging.info(f"{symbol}: Ù„Ø§ Ø¥Ø´Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ âŒ")
            print(f"{symbol}: Ù„Ø§ Ø¥Ø´Ø§Ø±Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ âŒ")

    except Exception as e:
        logging.error(f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ {symbol}: {e}")
        print(f"âš ï¸ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù„ÙŠÙ„ {symbol}: {e}")

def job():
    symbols = [
        "BTC-USD",   # Ø¨ÙŠØªÙƒÙˆÙŠÙ†
        "ETH-USD",   # Ø¥ÙŠØ«ÙŠØ±ÙŠÙˆÙ…
        "BNB-USD",   # Ø¨ÙŠÙ†Ø§Ù†Ø³
        "XRP-USD",   # Ø±ÙŠØ¨Ù„
        "ADA-USD",   # ÙƒØ§Ø±Ø¯Ø§Ù†Ùˆ
        "HBAR-USD"   # Ù‡ÙŠØ¯Ø±Ø§
    ]
    logging.info("ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²...")
    print("ğŸ” Ø¨Ø¯Ø¡ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ù…ÙˆØ²...")
    for s in symbols:
        analyze_symbol(s)

# â€”â€”â€” Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© â€”â€”â€”
schedule.every().hour.at(":00").do(job)

logging.info("âœ… Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø©...")
print("âœ… Ø§Ù„Ø¨ÙˆØª Ø¨Ø¯Ø£ ÙˆØ³ÙŠØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ÙƒÙ„ Ø³Ø§Ø¹Ø©...")

job()  # ØªØ´ØºÙŠÙ„ ÙÙˆØ±ÙŠ Ù„Ù„ØªØ¬Ø±Ø¨Ø©

while True:
    schedule.run_pending()
    time.sleep(60)
